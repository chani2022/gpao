{% set ROUTES_ACTIVE = app.request.attributes.get('_route') %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}App{% endblock %}</title>

    <link href="{{ absolute_url(asset("cooladmin/vendor/font-awesome-4.7/css/font-awesome.min.css")) }}"
          rel="stylesheet" media="all">
    <link href="{{ absolute_url(asset("cooladmin/vendor/font-awesome-5/css/fontawesome-all.min.css")) }}"
          rel="stylesheet" media="all">
    <link href="{{ absolute_url(asset("cooladmin/vendor/mdi-font/css/material-design-iconic-font.min.css")) }}"
          rel="stylesheet" media="all">
    {% block stylesheets %}

    {% endblock %}
    <link href="{{ absolute_url(asset("cooladmin/vendor/bootstrap-4.1/bootstrap.min.css")) }}" rel="stylesheet"
          media="all">

    <link href="{{ absolute_url(asset("cooladmin/vendor/select2/select2.min.css")) }}" rel="stylesheet" media="all">

    <link href="{{ absolute_url(asset("cooladmin/css/theme.css")) }}" rel="stylesheet" media="all">

    <link rel="stylesheet" type="text/css" href="{{ absolute_url(asset('js/summernote/summernote-bs4.css')) }}">

    <link rel="stylesheet" type="text/css" href="{{ absolute_url(asset('js/dropzone/dist/dropzone.css')) }}">

    <link rel="stylesheet" type="text/css" href="{{ absolute_url(asset('js/daterangepicker/daterangepicker.css')) }}">

   <!-- <link rel="stylesheet" type="text/css" href="{{ absolute_url(asset('messagebox/style.css')) }}">
   -->
    <style>

	
    .couleur_pannel{
        background:red!important;
    }
    /* Let's get this party started */
::-webkit-scrollbar {
    width: 12px;
}
 
/* Track */
::-webkit-scrollbar-track {
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3); 
    -webkit-border-radius: 10px;
    border-radius: 10px;
}
 
/* Handle */
::-webkit-scrollbar-thumb {
    -webkit-border-radius: 10px;
    border-radius: 10px;
    background: rgba(255,0,0,0.8); 
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5); 
}
::-webkit-scrollbar-thumb:window-inactive {
    background: rgba(255,0,0,0.4); 
}

        .boiteConversation {
            display: none;
        }

        .chatbox {
            position: fixed;
            bottom: -25px;
            left: 1%;
            right: 8%;
            width: 21%;
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            scrollbar-color: #4272d7 cornflowerblue;

        }
        .chatboxdiscut {
            position: fixed;
            bottom: 0px;
            left: 94%;
            right: 8%;
            width: 5%;
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            background-color: black!important;
            scrollbar-color: #4272d7 cornflowerblue;

        }
		
		
		.chatboxdiscut-gauche {
            position: fixed;
            bottom: 0px;
            left: 94%;
            right: 8%;
            /**width: 5%;**/
            z-index: 1000;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            scrollbar-color: #4272d7 cornflowerblue;
			list-style-type: none;
        }
		


        .chatbox2 {
            position: fixed;
            bottom: 0px;
            left: 55%;
            right: 8%;
            width: 25%;
            z-index: 100;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            scrollbar-color: #4272d7 cornflowerblue;

        }

        .chatbox3 {
            position: fixed;
            bottom: 0px;
            left: 27%;
            right: 8%;
            width: 25%;
            z-index: 100;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
            scrollbar-color: #4272d7 cornflowerblue;

        }

        .chatbox:focus {
            height: 300px;
            box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.3);
            scrollbar-color: #4272d7 cornflowerblue;
        }
		
		.chatboxdiscut-gauche>ui>li>.notViewMsg>.d-flex>.img_cont>.circle_right {
		  display: none;
		}


    </style>

    <style>

        .chat {
            margin-top: auto;
            margin-bottom: auto;
        }

        .card.chatbox {

            /**border-radius: 15px !important;**/
            background-color: #4272d7 !important;
        }

        .contacts_body {
            padding: 0.75rem 0 !important;
            overflow-y: auto;
            white-space: nowrap;
            height: 290px;
        }

        .msg_card_body {
            overflow-y: auto;
        }

        .card-header {
            /**border-radius: 15px 15px 0 0 !important;**/
            border-bottom: 0 !important;
        }

        .card-footer {
            border-radius: 0 0 15px 15px !important;
            border-top: 0 !important;
        }

        .container {
            align-content: center;
        }

        .search {
            border-radius: 15px 0 0 15px !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 0 !important;
            color: white !important;
        }

        .search:focus {
            box-shadow: none !important;
            outline: 0px !important;
        }

        .type_msg {
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 0 !important;
            color: white !important;
            height: 60px !important;
            overflow-y: auto;
        }

        .type_msg:focus {
            box-shadow: none !important;
            outline: 0px !important;
        }

        .attach_btn {
            border-radius: 15px 0 0 15px !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 0 !important;
            color: white !important;
            cursor: pointer;
        }

        .send_btn {
            border-radius: 0 15px 15px 0 !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 0 !important;
            color: white !important;
            cursor: pointer;
        }

        .search_btn {
            border-radius: 0 15px 15px 0 !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 0 !important;
            color: white !important;
            cursor: pointer;
        }

        .contacts {
            list-style: none;
            padding: 0;
        }

        .contacts li {
            width: 100% !important;
            padding: 5px 10px;
            margin-bottom: 15px !important;
        }

        .active {
            background-color: rgba(0, 0, 0, 0.3);
        }

        .user_img {
            height: 50px;
            width: 50px;
            /**border: 1.5px solid cornflowerblue;**/
            box-shadow: 0px 1px 2px black;

        }

        .user_img_msg {
            height: 40px;
            width: 40px;
            border: 1.5px solid #f5f6fa;

        }

        .img_cont {
            position: relative;
            height: 55px;
            width: 50px;
        }

        .img_cont_msg {
            height: 40px;
            width: 40px;
        }

        .online_icon {
            position: absolute;
            height: 15px;
            width: 15px;
            background-color: #4cd137;
            border-radius: 50%;
            bottom: 0.2em;
            right: 0.4em;
            border: 1.5px solid white;
        }

        .offline_icon {
            position: absolute;
            height: 15px;
            width: 15px;
            background-color: crimson;
            border-radius: 50%;
            bottom: 0.2em;
            right: 0.4em;
            border: 1.5px solid white;
        }

        .offline {
            background-color: #c23616 !important;
        }

        .user_info {
            margin-top: auto;
            margin-bottom: auto;
            margin-left: 15px;
        }

        .user_info span {
            font-size: 12px;
            color: white;
        }

        .user_info p {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .video_cam {
            margin-left: 50px;
            margin-top: 5px;
        }

        .video_cam span {
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-right: 20px;
        }

        .msg_cotainer {
            margin-top: auto;
            margin-bottom: auto;
            margin-right: 150px;
            border-radius: 25px;
            background-color: cornflowerblue;
            padding: 10px;
            position: relative;
            color: black;
            box-shadow: 0px 1px 2px black;
            text-align: justify;
        }

        .msg_cotainer_send {
            text-align: justify;
            color: black;
            margin-top: auto;
            margin-bottom: auto;
            margin-left: 140px;
            border-radius: 25px;
            background-color: #f1fbdd;
            padding: 10px;
            position: relative;
            box-shadow: 0px 1px 2px black;
            overflow:auto;
        }

        .msg_time {
            position: absolute;
            left: 0;
            bottom: -15px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
        }

        .msg_time_send {
            position: absolute;
            right: 0;
            bottom: -15px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
        }

        .msg_head {
            position: relative;
        }

        #action_menu_btn {
            position: absolute;
            right: 10px;
            top: 10px;
            color: white;
            cursor: pointer;
            font-size: 20px;
        }

        .action_menu {
            z-index: 1;
            position: absolute;
            padding: 15px 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border-radius: 15px;
            top: 30px;
            right: 15px;
            display: none;
        }

        /**a:focus {
            margin-top:300px;
        }
        **/
        /**#couleur_pannel.card.chatbox{
            background-color:red!important!important;
            opacity:0.5;
        }**/
		
.float{
	position:fixed;
	bottom:140px;
	color:#FFF;
	font-size:30px;
	z-index:100000000;
}
.float2{
	position:fixed;
	bottom:140px;
	color:#FFF;
	font-size:30px;
	z-index:100000000;
}
		
    </style>

</head>
<body style="background: #f7f7f7">
<div class="page-wrapper">
    <div id="{{ app.session.get('me') }}" class="me"></div>
    <!-- HEADER MOBILE-->
    <header class="header-mobile d-block d-lg-none">
        <div class="header-mobile__bar">
            <div class="container-fluid">
                <div class="header-mobile-inner">
                    <a class="logo" href="index.html">
                        <img src="images/icon/logo.png" alt="CoolAdmin"/>
                    </a>
                    <button class="hamburger hamburger--slider" type="button">
                                <span class="hamburger-box">
                                    <span class="hamburger-inner"></span>
                                </span>
                    </button>
                </div>
            </div>
        </div>
        <nav class="navbar-mobile">
            <div class="container-fluid">
                <ul class="navbar-mobile__list list-unstyled">
                    <li class="has-sub">
                        <a class="js-arrow" href="#">
                            <i class="fas fa-tachometer-alt"></i>Dashboard</a>
                        <ul class="navbar-mobile-sub__list list-unstyled js-sub-list">
                            <li>
                                <a href="index.html">Dashboard 1</a>
                            </li>
                            <li>
                                <a href="index2.html">Dashboard 2</a>
                            </li>
                            <li>
                                <a href="index3.html">Dashboard 3</a>
                            </li>
                            <li>
                                <a href="index4.html">Dashboard 4</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="chart.html">
                            <i class="fas fa-chart-bar"></i>Charts</a>
                    </li>
                    <li>
                        <a href="table.html">
                            <i class="fas fa-table"></i>Tables</a>
                    </li>
                    <li>
                        <a href="form.html">
                            <i class="far fa-check-square"></i>Forms</a>
                    </li>
                    <li>
                        <a href="calendar.html">
                            <i class="fas fa-calendar-alt"></i>Calendar</a>
                    </li>
                    <li>
                        <a href="map.html">
                            <i class="fas fa-map-marker-alt"></i>Maps</a>
                    </li>
                    <li class="has-sub">
                        <a class="js-arrow" href="#">
                            <i class="fas fa-copy"></i>Pages</a>
                        <ul class="navbar-mobile-sub__list list-unstyled js-sub-list">
                            <li>
                                <a href="login.html">Login</a>
                            </li>
                            <li>
                                <a href="register.html">Register</a>
                            </li>
                            <li>
                                <a href="forget-pass.html">Forget Password</a>
                            </li>
                        </ul>
                    </li>
                    <li class="has-sub">
                        <a class="js-arrow" href="#">
                            <i class="fas fa-desktop"></i>UI Elements</a>
                        <ul class="navbar-mobile-sub__list list-unstyled js-sub-list">
                            <li>
                                <a href="button.html">Button</a>
                            </li>
                            <li>
                                <a href="badge.html">Badges</a>
                            </li>
                            <li>
                                <a href="tab.html">Tabs</a>
                            </li>
                            <li>
                                <a href="card.html">Cards</a>
                            </li>
                            <li>
                                <a href="alert.html">Alerts</a>
                            </li>
                            <li>
                                <a href="progress-bar.html">Progress Bars</a>
                            </li>
                            <li>
                                <a href="modal.html">Modals</a>
                            </li>
                            <li>
                                <a href="switch.html">Switchs</a>
                            </li>
                            <li>
                                <a href="grid.html">Grids</a>
                            </li>
                            <li>
                                <a href="fontawesome.html">Fontawesome Icon</a>
                            </li>
                            <li>
                                <a href="typo.html">Typography</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>
    <!-- END HEADER MOBILE-->

    <!-- MENU SIDEBAR-->
    <aside class="menu-sidebar2 js-right-sidebar d-none d-lg-block">
        <div class="logo">
            <a href="#">
                <img src="{{ absolute_url(asset("images/logo-eline-small-archives.png")) }}" alt="ELINE"/>
            </a>
        </div>
        {{ render(controller('App\\Controller\\MainController::getMenus', {activeRoutes:ROUTES_ACTIVE})) }}
    </aside>
    <!-- END MENU SIDEBAR-->

    <!-- PAGE CONTAINER-->
    <div class="page-container2">
        <!--chani-->
        {#{ dump(app.session.get('list_user')) }#}
        <!--fin-->
        <!-- HEADER DESKTOP-->
        <header class="header-desktop2">
            <div class="section__content section__content--p30">
                <div class="container-fluid">
                    <div class="header-wrap">
                        <form class="form-header" action="" method="POST">
                            <input class="au-input au-input--xl" type="text" name="search"
                                   placeholder="Recherche rapide..."/>
                            <button class="au-btn--submit" type="submit">
                                <i class="zmdi zmdi-search"></i>
                            </button>
                        </form>
                        <div class="header-button2">
                            <div class="noti-wrap">
                                <div class="noti__item js-item-menu">
                                    <i class="zmdi zmdi-comment-more"></i>
                                    {{ render(controller('App\\Controller\\TransmissionController::getMyUnreadMessage')) }}

                                </div>
                            </div>


                            <div class="account-wrap">
                                <div class="account-item clearfix js-item-menu">
                                    <div class="image">
                                        <img src="http://192.168.8.3/public/user_photo/{{ app.user.userdetails["photo"] }}"
                                             alt="{{ app.user.userdetails['login'] }}"/>
                                    </div>
                                    {#<div class="content">
                                        <a class="js-acc-btn" href="#">{{ app.user.userdetails['login'] }}</a>
                                    </div>#}
                                    <div class="account-dropdown js-dropdown">
                                        <div class="info clearfix">
                                            <div class="image">
                                                <a href="#">
                                                    <img src="http://192.168.8.3/public/user_photo/{{ app.user.userdetails["photo"] }}"
                                                         alt="{{ app.user.userdetails['login'] }}"/>
                                                </a>
                                            </div>
                                            <div class="content">
                                                <h5 class="name">
                                                    <a href="#">{{ app.user.userdetails['login'] }}</a>
                                                </h5>
                                                <span class="email"></span>
                                            </div>
                                        </div>
                                        <div class="account-dropdown__body">
                                            <div class="account-dropdown__item">
                                                <a href="#">
                                                    <i class="zmdi zmdi-account"></i>Profil</a>
                                            </div>

                                        </div>
                                        <div class="account-dropdown__footer">
                                            <a href="{{ path("logout") }}">
                                                <i class="zmdi zmdi-power"></i>Quitter</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- HEADER DESKTOP-->

        <!-- MAIN CONTENT-->
        <div class="main-content">
            <div class="section__content section__content--p30">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="overview-wrap">
                                <h2 class="title-1"><a href="{{ app.request.headers.get('referer') }}"
                                                       title="Retour à la page précédente" class="btn btn-primary"><i
                                                class="fas fa-arrow-left"></i></a> {% block pageTitle %}Accueil{% endblock %}
                                </h2>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="pageContentWrapper">
                        <div class="col-lg-12 col-md-12" style="height:20px;"></div>
                        <div class="col-lg-12 col-md-12" style="font-size:12pt;">
                            {% if app.request.hasPreviousSession %}
                                {% for type, messages in app.session.flashbag.all() %}
                                    {% for message in messages %}
                                        <div style="" class="alert alert-{{ type }} alert-dismissible fade show">
                                            <i class="zmdi zmdi-info"></i>
                                            <span>{{ message|raw }}</span>
                                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        </div>


                        {% block body %}{% endblock %}
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="copyright">
                                <p>ELINE © 2020.</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>


        <!--Debut textebox user I-->
        <div class="col-md-10">
            <div id="couleur_pannel" class="chatbox card chatbox mb-sm-3 mb-md-0 contacts_card">
                <div  class="card-header">
                
                <div class="pull-right">
                    <button type="button" id="minimize_messagerie" style="color:aliceblue;margin-right: -20px;" title="Réduire" ><i style="font-size: 13px;" class='fas fa-minus-circle'></i>
                    </button>
                </div>
                
                    <div class="input-group" style="margin-left: -11px;">
                        <input type="text" placeholder="Recherche..." name="" class="form-control search">
                        <div class="input-group-prepend">
                            <span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                </div>

                <div class="card-body contacts_body">
                    {% for list_u in app.session.get('list_user') %}
                        <ui class="contacts" id="contacts{{ list_u.id_personnel }}" data-id="{{ list_u.login }}">
                            <li class="">
                                <a href="#" id="{{ list_u.id_personnel }}" class="lienbox">
                                    <div class="d-flex bd-highlight">
                                        <div class="img_cont">
                                            <img src="http://192.168.8.3/public/user_photo/{{ list_u.photo }}"
                                                 class="rounded-circle user_img">
                                            <span class="online_icon offline"></span>
                                        </div>

                                        <div class="user_info">
                                            <span><strong>{{ list_u.id_personnel }}</strong> - {{ list_u.login }}</span>
                                            <p>{{ list_u.nom_fonction }}</p>
                                        </div>
										
                                    </div>
                                </a>
                            </li>

                        </ui>
                    {% endfor %}
                </div>
                <div class="card-footer"></div>
            </div>
        </div>

    </div>
</div>
<!-- Fin textebox user I-->

<!--Debut textebox user II-->
        <div class="col-md-10" >
            <div id="message_not_view" class="chatopacity chatboxdiscut-gauche mb-sm-3 mb-md-0 contacts_card">
                <div id="chat_opacity" class="card-header">
				
                    <div class="input-group">
                        
                    </div>
                </div>

                <div class="card-body contacts_body">
                <!--F
                <li class="">
                                <a href="#"  class="lienbox">
                                    <div class="d-flex bd-highlight">
                                        <div class="img_cont">
                                            <img src="#"
                                                 class="rounded-circle user_img">
                                            <span class="online_icon offline"></span>
                                        </div>

                                        <div class="user_info">
                                           
                                        </div>
                                    </div>
                                </a>
                            </li>
                --F-->
                    
                </div>
                
            </div>
        </div>

    </div>
</div>
<!-- Fin textebox user II-->


<!-- Debut messagebox user-->

<div class="col-md-10">
    <div id="element2" name="Rakoto" class="chatbox2 card chatbox boiteConversation mb-sm-3 mb-md-0 contacts_card">
        <div class="card-header">
            <div class="msg_head">
                <div class="pull-right" style="margin-left: 20px;">
                    <button type="button" class="close close_conversation">
						<i style="font-size: 13px; z-index: 500;" class='fa fa-times'></i>
					</button>
                </div>
                <div class="pull-right">
                    <button type="button" class="close minimize"><i style="font-size: 13px;" class='fa fa-minus'></i>
                    </button>
                </div>
                <div class="d-flex bd-highlight">
                    <div class="img_cont">
                        <img src="{{ absolute_url(asset("public/images/profil.png")) }}"
                             class="rounded-circle user_img">
                        <span class="online_icon offline"></span>
                    </div>
					
                    <div class="user_info">
                        <span>Conversation avec Rakoto</span>
                    </div>
					
					<button class="float2 lastMsg" title="Ancien message" id="">
						<i class="fa fa-arrow-circle-up" aria-hidden="true"></i>
					</button>
                </div>
                <!--<span id="action_menu_btn"><i class="fa fa-times"></i></span>-->
            </div>
        </div>
        <div id="msg_card_body_00" class="card-body msg_card_body" style="display:none">
            <!--femeture 0-->
            <div class="msg_content container_message" style="height: 300px;overflow: auto;">
               
            </div>
            <!--fin femeture 0-->

            <!-- fermeture 01-->
            <div class="msg_content" style="padding: .75rem 1.25rem;background:#3B5998;">
                <div class="input-group">
                    <div class="input-group-append">
                            <span class="input-group-text attach_btn">
                    </div>
                    <textarea id="type_msg_00" name="" class="form-control type_msg"
                              placeholder="Taper votre message..."></textarea>
                    <div class="input-group-append">
                        <span id="send_btn_00" class="input-group-text send_btn"><i
                                    class="fas fa-location-arrow"></i></span>
                    </div>
                </div>
            </div>
            <!--femeture 01-->
        </div>

    </div>
</div>

</div>
</div>

<!-- Fin messagebox user-->

<!-- Debut messagebox2 user-->

<div class="col-md-10">
    <div name="Alain José" style="background:green;"
         class="chatbox3 card chatbox boiteConversation mb-sm-3 mb-md-0 contacts_card">
        <div class="card-header">
            <div class="msg_head">
                <div class="pull-right" style="margin-left: 20px; z-index:1500;">
                    <button type="button" class="close close_conversation"><i style="font-size: 13px;z-index:500;"
                                                                              class='fa fa-times'></i></button>
                </div>
                <div class="pull-right">
                    <button type="button" class="close minimize"><i style="font-size: 13px;" class='fa fa-minus'></i>
                    </button>
                </div>
				 
                <div class="d-flex bd-highlight">
				
                    <div class="img_cont">
                        <img src="{{ absolute_url(asset("public/images/profil.png")) }}"
                             class="rounded-circle user_img">
                        <span class="online_icon offline"></span>
                    </div>
                    <div class="user_info">
                        <span>Conversation avec Alain José</span>
			            
                    </div>
					
					<button title="Ancien message" class="float lastMsg">
						<i class="fa fa-arrow-circle-up" aria-hidden="true"></i>
					</button>
					
					
                  
                </div>

            </div>
        </div>

        <div id="msg_card_body_01" class="card-body msg_card_body">
            <!-- fermeture 2-->
            <div class="msg_content container_message" style="height: 300px;overflow: auto;">
             

            </div>
            <!--fin fermeture 1-->
            <!--fermeture 2-->
            <div style="padding: .75rem 1.25rem;background: #3B5998;">
                <div class="input-group">
                    <div class="input-group-append">
                                <span class="input-group-text attach_btn">
                    </div>
                    <textarea id="type_msg_01" class="form-control type_msg"
                              placeholder="Taper votre message..."></textarea>
                    <div class="input-group-append">
                        <span id="send_btn_01" class="input-group-text send_btn"><i
                                    class="fas fa-location-arrow"></i></span>
                    </div>
                </div>
            </div>
            <!--fin fermeture 2-->
        </div>
        
    </div>
    

</div>


</div>
</div>

</div>
</div>

<!-- Fin messagebox2 user-->

<!-- Debut messagebox3 user-->



<!-- Fin messagebox3 user-->


<script src="{{ absolute_url(asset("cooladmin/vendor/jquery-3.2.1.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/bootstrap-4.1/popper.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/bootstrap-4.1/bootstrap.min.js")) }}"></script>

<!-- Vendor JS       -->
<script src="{{ absolute_url(asset("cooladmin/vendor/slick/slick.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/wow/wow.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/animsition/animsition.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/bootstrap-progressbar/bootstrap-progressbar.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/counter-up/jquery.waypoints.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/counter-up/jquery.counterup.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/circle-progress/circle-progress.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/perfect-scrollbar/perfect-scrollbar.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/chartjs/Chart.bundle.min.js")) }}"></script>
<script src="{{ absolute_url(asset("cooladmin/vendor/select2/select2.min.js")) }}"></script>

<script src="{{ absolute_url(asset("cooladmin/js/main.js")) }}"></script>

<script type="text/javascript" src="{{ absolute_url(asset('js/dropzone/dist/min/dropzone.min.js')) }}"></script>
<script type="text/javascript" src="{{ absolute_url(asset('js/summernote/summernote-bs4.min.js')) }}"></script>

<script type="text/javascript" src="{{ absolute_url(asset('js/daterangepicker/moment.min.js')) }}"></script>
<script type="text/javascript"
        src="{{ absolute_url(asset('js/daterangepicker/moment-with-locales.min.js')) }}"></script>
<script type="text/javascript" src="{{ absolute_url(asset('js/daterangepicker/daterangepicker.js')) }}"></script>

<script src="{{ absolute_url(asset("js/lib.js")) }}"></script>

<script src="{{ absolute_url(asset('bundles/fosjsrouting/js/router.min.js')) }}"></script>
<script src="{{ url('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>
<script>
    var data_socket = [];
    var timeOutMsg;
    var titleInit = "";
    var msgReceving = false;
    var compteurMsgRecev = 0;
    var panelConversationSlideUp = false;
    var oneMsg = 0;
    var twoMsg = 0;
    var animation;
    var Color;
    var animationColor;
    var msg1 = false;
    var newMsg = false;
    var nbPanelShow = 0;
    var isIdPanelEqual = false;
    var animRun = true;
    var evit_not_doublons = false;
    var list_id_and_compteur_msg_last = [];
    var list_message_not_view = [];
    
    var list_panel_default = [];
    var list_final_msg_not_view = [];
    var list_panel_block = [];
    var list_user_show_preview = [];
    moment.locale('fr');
    var me = $('.me').attr("id");

    //socket
    //var ws = new WebSocket("ws://192.168.8.9:8765");
    
    $(document).ready(function () {
        
        $("label.required").addClass("text-danger");
        titleInit = $('title').text();
    });
    //messagerie
    $(function () {
		
        //Couleur du panneaux de messagerie
        
        var $card_body = $("#minimize_messagerie").parents('.chatbox ').children('.card-body');
        $card_body.slideToggle();
                
        //Opacité du boutton ancien message
		
		$(".float2").css("opacity","0.1");
		$(".float").css("opacity","0.1");
		
	  $( ".float2" ).mouseover(function() {
			$(".float2").css("opacity","0.5");
	  })
	  .mouseout(function() {
			$(".float2").css("opacity","0.1");
	  });
	  
	  
	  $( ".float" ).mouseover(function() {
			$(".float").css("opacity","0.5");
	  })
	  .mouseout(function() {
			$(".float").css("opacity","0.1");
	  });
		
	
	//chatboxdiscut-gauche
	
	
	$( ".rounded-circle user_img" ).mouseover(function() {
		//$( "div", this ).css("background","red");
	  })
	  .mouseout(function() {
		//$( "div", this ).css("background","green");
	  });
	 

	
	
	/**jQuery("#message_not_view li a:hover, a").mouseenter(function ()
        {
			alert("okokok");
            //jQuery("div#login-container").css("display", "block");
        });***/
	
	
	
	   //...Lorsqu'on clique sur le bulle du chat reduction à gauche
	$('.chatopacity').find( "ui" ).mouseenter(function(){
		//$('.user_img').css("background","yellow");
		//var allAs=$("#message_not_view li a:hover, a").find("#circle_right");
		 //allAs.parents(allAs).children('#circle_right').css("display","block");
		 //$('#message_not_view li a:hover, a' + $(this).data('id')).find("#circle_right").css("display","block");
    });

    //Lorsque la souris ressort du div...
    $(".chatopacity").mouseleave(function(){
		//var allAs=$("#message_not_view li").find("#circle_right");
		//allAs.css("display","none");
    });
		
		
    $("#couleur_pannel").mouseenter(function(){
        //...On ajoute une couleur de fond au div
        $(this).addClass('couleur_pannels');
        
    });

    //Lorsque la souris ressort du div...
    $("#couleur_pannel").mouseleave(function(){
        //...On remet un fond blanc
        $(this).addClass('couleur_pannels');
    });
        
        //mise a jour de donnees socket
        function updateAndSendData(data, $textarea, destinataire) {
            if ($textarea.val() !== "") {
                data["type"] = "message";
                data["data"]["destinataire"] = destinataire;
                data["data"]["text"] = $textarea.val();
                ws.send(JSON.stringify(data));

                $textarea.val("");
                $textarea.focus();
            }
        }

        function createListMessageNotView(container, message_not_view){
                container.html("");
                //console.log("list", message_not_view);
                /**
                raha ita ao @panel de conversation ilay ul de esorin ao anatin le panel message not view
                */
                for(var i=0; i< message_not_view.length; i++){
                    var UserShowInPanel = false;
                    if(panel_block.length > 0){
                        for(var j=0; j<panel_block.length; j++){
                            if(panel_block[j].id == message_not_view[i].id){
                                UserShowInPanel = true;
                                //message_not_view.splice(i,1);

                                for(var k=0; k<list_message_not_view.length; k++){
                                    if(panel_block[j].id == list_message_not_view[k]["me"]){
                                        list_message_not_view.splice(k,1);
                                        //tab_temp_old_data_delete.push(list_message_not_view[k]);
                                    }
                                }
                            }
                        }
                    }

                    if(!UserShowInPanel){

                        if($('#message_not_view').find('ui#'+message_not_view[i].id).length > 0){
                            $('#message_not_view').find('ui#'+message_not_view[i].id).remove();   
                        }
                        var ui = $('<ui id="'+message_not_view[i]["id"]+'" class="contact">' +
                                    '<li class="">' +
                                        '<a id="'+message_not_view[i]["id"]+'"class="notViewMsg" href="#">' +
                                            '<div class="d-flex bd-highlight">' +
                                                '<div class="img_cont">' +
                                                    '<img class="rounded-circle user_img" src="'+message_not_view[i]["img"]+'">'+
                                                '</div>'+
												'<i id="circle_right" style="font-size: 13px;color:currentColor;display:none" class="fa fa-times-circle"></i>'+
                                            '</div>'+
                                        '</a>'+
                                    '</li>'+
                                '</ui>');
                        container.append(ui);
                    }
                }
                /**
                panel_block = [];
                $('.boiteConversation').each(function(){
                    if($(this).css("display") == "block"){
                        panel_block.push($(this).attr("id"));
                    }
                });

                /**
                *affichage des avatars des personnel des message non lu
                **/
				
				
				//permet d'afficher le croix sur le bulle gauche
				container.delegate('.notViewMsg', 'mouseenter', function(event) {
					
					
					//$('#message_not_view').find('ui#'+id_msg_not_view).css("background-color","yellow");
					
						//$('#message_not_view li a:hover, a' + $(this).data('id')).parent().parent().css("background","yellow");
					
							 $('#message_not_view li a:hover, a' + $(this).data('id')).find("#circle_right").css("display","block");
								
								//Permet de supprimer la message bulle à gauche
								
								  $('#message_not_view li a:hover, a' + $(this).data('id')).find("#circle_right").click(function(e){
									  e.preventDefault();
									  
										//$(this).closest("div.post-it").fadeOut();
										$('#message_not_view li a:hover, a' + $(this).data('id')).parent().parent().remove();
										console.log(list_message_not_view);
										
										
												var x = $(this).parent().parent().attr('id');
												for(var i=0; i<list_message_not_view.length; i++){
														//if(x==list_message_not_view[i]["me"]){
															//list_message_not_view.splice(i);
														//}
														if(list_message_not_view[i]["me"] == x){
															list_message_not_view.splice(i,1);
														}
														
													}
												
										for(var i=0; i<list_message_not_view.length;i++){
											for(var j=0; j<tab_temp_old_data_delete.length;j++){
												if(list_message_not_view[i]["me"] == tab_temp_old_data_delete[j]["me"]){
													tab_temp_old_data_delete.splice(j,1);
												}
											}
										}
										list_message_not_view = list_message_not_view.concat(tab_temp_old_data_delete);

									});
									
					  }
                    );
				
				//permet de cacher le croix sur le bulle gauche
					container.delegate('.notViewMsg', 'mouseleave', function(event) {
							 var allAs=$("#message_not_view li").find("#circle_right");
							allAs.css("display","none");
						}
                    );
					
                container.delegate('.notViewMsg', 'click', function(event) {
					
					event.preventDefault();
                    var id_user_panel_preview = $('.boiteConversation:first').attr("id");

                    var id_msg_not_view = $(this).attr("id");
                    var nb_user_msg_not_view = "";
                    user_clicked = false;
                    evit_not_doublons = true;

                    nb_user_msg_not_view = $('#message_not_view').find('ui').length;
                    
                    $('.contacts#contacts'+id_msg_not_view).find('a#'+id_msg_not_view).trigger('click');

                    $('#message_not_view').find('ui#'+id_msg_not_view).remove();
                    
                    /**
                    $('.boiteConversation:first').css({
                        "backgroundColor":"rgb(66, 114, 215)"});
                    //list_message_not_view.push()
                    /**
                    on met a jour la liste des panel apres click
                    **/
                    //if(msgReceving){

                            panel_block = [];
                            $('.boiteConversation').each(function(){
                                if($(this).css("display") == "block"){
                                    var user = {
                                        "id":$(this).attr("id"),
                                        "img":$(this).find('.img_cont').find('img').attr("src"),
                                        "msgNotView":true,
                                        //"data": data
                                    };
                                    panel_block.push(user);
                                    /**
                                    if(nbPanelShow > 0){
                                        animClr(data["me"]);   
                                    } **/
                                }
                            });

                            $('.boiteConversation:first').find('.type_msg').trigger('click');
                           
                            /**
                            on permute l'utilisateur cliquer sur panel not view msg et la panel de conversation
                            */
                            var tab_temp_user_show_preview_in_panel_conversation = [];
                            var user_perm = "";
                            
                            
                            for(var i=0; i<list_message_not_view.length; i++){
                                if(id_msg_not_view == list_message_not_view[i]["me"]){
                                    
                                    var datas = {
                                        "type": "other",
                                        "me": list_message_not_view[i]["me"],
                                        "data": {
                                            //"listeUser": [],
                                            "destinataire": list_message_not_view[i]["me"],
                                        },
                                        "messageData":{

                                        }
                                    };
                                    
                                    list_message_not_view[i]["me"] = id_user_panel_preview;
                                    list_message_not_view[i]["data"]["destinataire"] = id_user_panel_preview;
                                    user_perm = list_message_not_view[i];

                                    tab_temp_old_data_delete.push(datas);
                                        
                                }
                            }
                            
                            /**
                            on enleve les doublons dans eviter la repetition des images dans la panel de message not view
                            */

                            for(var i=0; i<tab_temp_old_data_delete.length;i++){
                                if(tab_temp_old_data_delete[i] !== undefined){
                                    for(var j=0; j<list_message_not_view.length;j++){
                                        if(tab_temp_old_data_delete[i]["me"] == list_message_not_view[j]["me"]){
                                            tab_temp_old_data_delete.splice(i,1);
                                        }
                                    }
                                }
                            }
                            
                            /**
                            enlever les doublons
                            **/
                            for(var i=0; i<panel_block.length;i++){
                                for(var j=0; j<list_message_not_view.length;j++){
                                    var tab_splice = [];//tab pour enlever les doublons
                                    for(var k=j+1; k<list_message_not_view.length; k++){
                                        if(list_message_not_view[j]["me"] == list_message_not_view[k]["me"]){
                                            tab_splice.push(k);
                                        }
                                    }
                                    if(tab_splice.length > 0){
                                        for(var l=0; l<tab_splice.length;l++){
                                            list_message_not_view.splice(tab_splice[l],1);
                                        }
                                    }
                                    if(panel_block[i].id == list_message_not_view[j]["me"]){
                                        list_message_not_view.splice(j,1);
                                        
                                    }
                                }
                            }
                            
                            /**
                            mise a jours des panel de message not view
                            **/
                            if(panel_block.length == 2 || panel_block.length == 1){

                                if(nb_user_msg_not_view > 0){
                                    var userOnPanel = false;
                                    for(var i=0; i<panel_block.length; i++){
                                        if(panel_block[i].id == user_perm["me"]){
                                            userOnPanel = true;
                                        }
                                    }
                                    
                                    if(user_perm && !userOnPanel){
                                        var found = false;
                                        $('#message_not_view').find('ui').each(function(){
                                            if($(this).attr("id") == user_perm["me"]){
                                                found = true;
                                            }
                                        });
                                        if(!found){
                                            var id = $('.lienbox#'+user_perm["me"]).attr("id");
                                            var img = $('.lienbox#'+user_perm["me"]).find('.img_cont').find('img').attr("src");
                                            if(id !== undefined){
                                                var ui = $('<ui id="'+id+'" class="contact">' +
                                                            '<li class="">' +
                                                                '<a id="'+id+'"class="notViewMsg" href="#">' +
                                                                    '<div class="d-flex bd-highlight">' +
                                                                        '<div class="img_cont">' +
                                                                            '<img class="rounded-circle user_img" src="'+img+'">'+
                                                                        '</div>'+
                                                                    '</div>'+
                                                                '</a>'+
                                                            '</li>'+
                                                        '</ui>');
                                                $('#message_not_view').append(ui);
                                            }

                                        }
                                    }
                                }
                            }
                    /**
                            //showUserInPanelMsgNotView(); 
                            //msgReceving = false;
                    //}else{
                        
                        raha 1 ilay panel de conversation de nis message tonga nef nefermena de raha vo clicken de tonga de atw vue
                        
                        for(var i=0; i<list_message_not_view.length; i++){
                            $('.boiteConversation').find('.type_msg#'+list_message_not_view[i]["me"]).trigger('click');
                        }
                    }
                  **/
                });
                /**
                effacement manuel des utilisateur dans la panel not view
                
                container.delegate('.user_delete', 'click', function(event) {
		
                    event.preventDefault();
                   var id_msg_not_view = $(this).attr("id");
                   $(this).parents('ui').remove();
                   
                   for(var i=0; i<list_message_not_view.length;i++){
                        if(list_message_not_view[i]["me"] == id_msg_not_view){
                            list_message_not_view.splice(i,1);
                        }
                   }
                   for(var j=0; j<tab_temp_old_data_delete.length;j++){
                        if(tab_temp_old_data_delete[i]["me"] == id_msg_not_view){
                            tab_temp_old_data_delete.splice(j,1);
                        }
                   }
                });  **/
            }

            function showUserInPanelMsgNotView(){
                var list_msg = [];
                
                //console.log(list_message_not_view);

                for(var i=0; i<list_message_not_view.length;i++){
                        if(list_message_not_view[i]["me"] != "element2"){
                            var id = $('.lienbox#'+list_message_not_view[i]["me"]).attr("id");
                            var img = $('.lienbox#'+list_message_not_view[i]["me"]).find('.img_cont').find('img').attr("src");
                            var user_msg_not_view = {
                                    "id": id,
                                    "img":img
                                    };
                            list_msg.push(user_msg_not_view);    
                        }else{
                            //list_message_not_view.splice(i,1);
                        }       
                }

                createListMessageNotView($('#message_not_view'), list_msg); 
               
            }
            /**
             * notification de nouveau message si il y a 2 panel de conversation
             */
            function animClr(id_destinataire){
                $('.boiteConversation').each(function(index, item){
                    if(id_destinataire == $(this).attr("id")){
                        
                        $(this).children( ".card-header" ).css({ 'background': 'crimson' });
                        //bgCardBody = 'crimson';
                    }
                })
            }

        var list_user_to_create_dialog = [];
        var info_destinataire = {};
        var panel_block = [];
        var list_users = {{ app.session.get('list_user')|json_encode|raw }};
        var user_clicked = true;
        var active_msg_not_view = false;
        var tab_temp_old_data_delete = [];
        var msgsNotView = [];
        var bgCardBody = "";
        var soustraction = 1;
        //console.log(list_users);
        //socket
        var ws = new WebSocket("ws://192.168.9.253:8765");
        //me
        
        var isKeyDown = false;

        //donnee socket
        var data = {
            "type": "connexion",
            "me": me,
            "data": {
                "listeUser": [],
                "destinataire": 0,
                "text": "",
                "date": moment().startOf('hour').fromNow()//date moment,
            }
        };
        //ouverture de la connexion
            ws.onopen = function (event) {
                ws.send(JSON.stringify(data));
                var destinataire = "";
                var id_textarea = "";

                /**
                 * keyup no apesain fa raha tsizan de azon le panel faharo ilay \n
                 **/
                $('textarea.type_msg').keyup(function (e) {
                    //touche entrer du clavier
                    if (e.keyCode == 13) {
                        isKeyDown = true;
                        if($(this).val().trim() !== ""){
                            $(this).parents('.boiteConversation').find('.send_btn').trigger('click', [$(this).attr("id")]);
                        }
                    }
                });

                $('.send_btn').click(function (e, id_destinataire) {
                    var textarea = $(this).parents('.boiteConversation').find('.type_msg');
                    if(id_destinataire){
                        if($(this).attr("id") == id_destinataire){
                            destinataire = id_destinataire;    
                        }
                    }else{
                        destinataire = textarea.attr("id");
                    }
                    updateAndSendData(data, textarea, destinataire);                        
                   
                });

            };
            ws.onmessage = function (event) {
                var data = JSON.parse(event.data);
                //console.log(data);

                /**
                 * créér une element dans la panel de conversation
                 *
                 * @param isMeRecevingMsg (boolean si message est recu par un utilisateur)
                 * @param containerMsg
                 * @param user (utilisateur qui est clique par jquery lors de renvoye de message)
                */
                 function createElementsNode(isMeRecevingMsg, containerMsg, user){
                    containerMsg.html("");
                    var styleContainer = "d-flex mb-4 justify-content-";
                    var listDate = [];
                    /**
                    * recuperation de dernier message
                    **/
                    for(var i in data["messageData"]){
                        listDate.push(i);
                    }

                    for(var i=0; i<list_id_and_compteur_msg_last.length; i++){
                        if(list_id_and_compteur_msg_last[i].id == data["data"]["destinataire"]){
                            if(list_id_and_compteur_msg_last[i].cpt > listDate.length){
                                if(listDate.length > 2){
                                    list_id_and_compteur_msg_last[i].cpt = 2;
                                }else{
                                    list_id_and_compteur_msg_last[i].cpt = 1;
                                }
                                soustraction = 1;
                            }else{
                                soustraction = list_id_and_compteur_msg_last[i].cpt;
                            }
                        }
                    }
                    
                    //-------------------------------------
                    var dateLast = listDate[listDate.length - soustraction];//date de dernier conversation par defaut
                    
                    if(isMeRecevingMsg){
                        //conversation
                        /**
                        *on compare la date du dernier conversation et la date de liste des *Conversation
                        * puis, on le filtre
                        */
                        for(var i in data["messageData"]){
                            if(i == dateLast){
                                var day = i.substring(0,2);
                                var month = i.substring(2,4);
                                var year = i.substring(4, i.length);
                                var dateCurrent = day+"/"+month+"/"+year;
                                for(var j in data["messageData"][i]){
                                    var container = $('<div></div>');
                                    var vue = "";
                                    if(data["messageData"][i][j]["pour"] != me){
                                        if(data["messageData"][i][j]["lu"] == 1){
                                                vue = "Lu, le ";
                                            }
                                        container.addClass(styleContainer +"end mb-4");
                                        
                                        var subElement = $('<div class="msg_cotainer_send">' +
                                        '<p>' +
                                            data["messageData"][i][j]["texte"]+
                                        '</p><p style="color:darkslategrey">' + 
                                            vue +""+dateCurrent+" à "+data["messageData"][i][j]["heure"] +
                                            //data["messageData"][i][j]["heure"] +
                                        '</p>'+
                                        '</div>');
                                        container.append(subElement);
                                        containerMsg.append(container); 
                      
                                    }else{
                                        
                                        if(data["messageData"][i][j]["lu"] == 1){
                                                                        vue = "Lu, le ";
                                                                    }
                                        container.addClass(styleContainer +"start mb-4");    
                                        subElement = $('<div class="col-md-12">' +
                                                        '<div class="img_cont_msg">' +
                                                            '<img class="rounded-circle user_img_msg" src="'+containerMsg.parents('.boiteConversation').find('.img_cont').find('img').attr("src")+'">'+
                                                        '</div>'+
                                                        '<div class="msg_cotainer">' +
                                                                '<p>' +
                                                                     data["messageData"][i][j]["texte"]+
                                                                '</p><p style="color:darkslategrey">' +
                                                                    
                                                                   vue +""+dateCurrent+" à "+ data["messageData"][i][j]["heure"] +
                                                                   //data["messageData"][i][j]["heure"] +
                                                                '</p>'+
                                                        '</div>'+
                                                '</div>');
                                    
                                    container.append(subElement);
                                    containerMsg.append(container);  
                                }     
                            }
                        }
                    
                        }
                    }
                    else{
                        for(var i in data["messageData"]){
                            if(i == dateLast){
                                var day = i.substring(0,2);
                                var month = i.substring(2,4);
                                var year = i.substring(4, i.length);
                                var dateCurrent = day+"/"+month+"/"+year;

                                for(var j in data["messageData"][i]){
                                    var container = $('<div></div>');
                                    var msgLu = null;
                                    if(data["messageData"][i][j]["de"] == me){
                                    
                                        if(data["messageData"][i][j]["lu"] == 1){
                                            msgLu = "Lu, le ";
                                        }
                                        container.addClass(styleContainer +"end mb-4");
                                        var subElement = $('<div class="msg_cotainer_send">' +
                                        '<p>' +
                                            data["messageData"][i][j]["texte"]+
                                        '</p><p style="color:darkslategrey">' +
                                            msgLu +""+dateCurrent+" à "+data["messageData"][i][j]["heure"] +
                                        '</p>'+
                                        '</div>');
                                        
                                        container.append(subElement);
                                        containerMsg.append(container);   
                                    }
                                    /**
                                    if(data["messageData"][i][j]["pour"] == data["data"]["destinataire"]){**/
                                    else{
                                        if(data["messageData"][i][j]["lu"] == 1){
                                            msgLu = "lu, le ";
                                        }
                                        container.addClass(styleContainer +"start mb-4");    
                                    
                                    //container.addClass(styleContainer +"start mb-4");
                                        subElement = $('<div class="col-md-12">' +
                                                        '<div class="img_cont_msg">' +
                                                            '<img class="rounded-circle user_img_msg" src="'+/**user.find('.img_cont').find('img').attr("src")**/containerMsg.parents('.boiteConversation').find('.img_cont').find('img').attr("src")+'">'+
                                                        '</div>'+
                                                        '<div class="msg_cotainer">' +
                                                                '<p>' +
                                                                     data["messageData"][i][j]["texte"]+
                                                                '</p><p style="color:darkslategrey">' +
                                                                    msgLu+""+data["messageData"][i][j]["heure"] +
                                                                '</p>'+
                                                        '</div>'+
                                                '</div>');
                                        
                                    container.append(subElement);
                                    containerMsg.append(container);
                                    //containerMsg.scrollTop(containerMsg[0].scrollHeight);
                                }     
                            }
                        }
                        }
                    }
                    containerMsg.scrollTop(containerMsg[0].scrollHeight);
                }


                if (data["data"] !== undefined) {
                    switch (data["type"]) {
                        /**
                         * lu des msg
                        */
                        case 'messageLu':
                            //console.log(data);
                            /**
                            $('body').find('.boiteConversation').each(function(){
                                if($(this).attr("id") == data["data"]["destinataire"]){
                                    var container = $(this).find('.container_message');
                                    createElementsNode(true, container);        
                                }
                            });**/
                            
                        /**
                         * activation de la status du personnel connecté
                         ***/
                        case 'connexion':
                            
                            /**
                             * chargement des donnees ato
                             */
                            data_socket = data;

                            for (var i = 0; i < data["data"]["listeUser"].length; i++) {
                                $('.lienbox').each(function () {
                                    if ($(this).attr("id") == data["data"]["listeUser"][i]) {
                                        $(this).find('.online_icon').removeClass('offline');
                                    }
                                });
                            }
                        case "message":

                            newMsg = true;
                            /**
                             * remettre le curseur de la souris d'un texteareo au début lors de l'évènement entrer du clavier
                            */
                            if (isKeyDown) {
                                var textarea = document.getElementsByClassName('type_msg');
                                for (var i = 0; i < textarea.length; i++) {
                                    textarea[i].setSelectionRange(1, 2);
                                }
                                isKeyDown = false;
                            }
                            if ((data["data"]["destinataire"] == me) || (data["me"] == me)) {
                                /**
                                 * lors de l'envoyer du message
                                 * on cherche la panel de conversation du destinataire
                                 **/
                                if (data["me"] == me) {
                                    for(var i=0; i<list_id_and_compteur_msg_last.length; i++){
                                            if(list_id_and_compteur_msg_last[i].id == data["me"]){
                                                soustraction = 1;
                                            }
                                        }
                                        var $container_msg = $('.container_message');
                                        var cnt = "";
                                        $container_msg.each(function () {
                                            if (parseInt($(this).attr("id")) == parseInt(data["data"]["destinataire"])) {
                                                cnt = $(this);
                                                //$(this).html("");
                                                
                                                //var dataMsg = data["messageData"];
                                            }
                                        });
                                        if (cnt.length > 0) {
                                            createElementsNode(false, cnt);
                                        }
                                    }

                                /**
                                 * reception du message d'un utilisateur
                                 **/
                                else if (parseInt(data["data"]["destinataire"]) == parseInt(me)) {
                                    if(data["type"] == "messageLu"){
                                        //eto za zo refveo chargement msg
                                        $('.lienbox').each(function(){
                                            if($(this).attr("id") == data["me"] && data["data"]["destinataire"] == me){
                                                user_clicked = false;
                                                $(this).trigger('click');  
                                            }
                                        });
                                    }else{
                                        
                                        msgReceving = true;
                                        compteurMsgRecev++;
                                        twoMsg ++;
                                        oneMsg ++;
                                        /**
                                        for(var i=0; i<list_id_and_compteur_msg_last.length; i++){
                                            if(list_id_and_compteur_msg_last[i].id == data["data"]["destinataire"]){
                                                soustraction = 1;
                                            }
                                        }
                                        /**
                                        si un nouveau message est venu et qu'il est dans la panel de message not view,
                                        on l'enleve dans ce dernier puis, on le supprime dans la list des message not view
                                        **/
                                        if($('.contacts#contacts'+data["me"]).find('a#'+data["me"]) > 0){
                                            $('.contacts#contacts'+data["me"]).find('a#'+data["me"]).remove();
                                        }
                                        
                                        /**
                                         * animation du titre de l'app
                                         */
                                        animation = function recurs(){
                                            timeOutMsg = setTimeout(function(){
                                                var msg = "Vous avez un nouveau message";
                                                var title = $('title').text();

                                                if(title == msg){
                                                    $('title').text(titleInit);
                                                }else{
                                                    $('title').text(msg);
                                                }
                                                recurs();
                                            },500);
                                        }
                                        if(animRun){
                                            animation();
                                        }
                                        /**
                                         * rehefa mahazo focus le window dia mial ilay animation le titre
                                        */
                                        $(window).focus(function () {
                                            clearTimeout(timeOutMsg);
                                            $('title').text(titleInit);
                                            animRun = true;
                                        });
                                        /**
                                         * rehefa mahazo focus le textarea mcorrespondre dia mial ilay soratra oe nouveau message de atw vue le msg
                                         **/
                                        $('textarea.type_msg').each(function (e) {
                                            $(this).click(function (e) {
                                                //console.log(data);
                                                if ($(this).attr("id") == data["me"]) {
                                                    $(this).parents('.boiteConversation').find('.user_info p').last().text("");
                                                    
                                                    $(this).parents('.boiteConversation').children( ".card-header" ).css({ 'background': 'rgba(0,0,0,.03)' });
                                                    
                                                    
                                                    clearTimeout(timeOutMsg);
                                                    $('title').text(titleInit);
                                                    animRun = true;
                                                    
                                                    if(data["data"]["destinataire"] == me && $(this).attr("id") == data["me"]){
                                                        var isAllMsgView = true;
                                                        data["type"] = "messageLu";
                                                        for(var i in data["messageData"]){
                                                            for(var j in data["messageData"][i]){
                                                                        if(data["messageData"][i][j]["lu"] == 0){
                                                                            data["messageData"][i][j]["lu"] = 1;   
                                                                            isAllMsgView = false;
                                                                        }
                                                                    
                                                            }
                                                        }
                                                        if(!isAllMsgView){
                                                            ws.send(JSON.stringify(data));
                                                            
                                                        }
                                                    }
                                                }
                                            });
                                        });

                                        animRun = false;
                                        compteurMsgRecev = 0;

                                        /**
                                         * manokatra ny panel de conversation
                                         */
                                         
                                        list_message_not_view.push(data);
                                        $classUser.each(function () {
                                            if (parseInt($(this).attr("id")) == parseInt(data["me"]) && data["data"]["destinataire"] == me) {
                                                var id_user = $(this).attr("id");
                                                var container_conversation = [];//liste de panel de conversation

                                                user_clicked = false;
                                                $(this).trigger('click');
                                                //user_clicked = true;

                                                
                                                $('.boiteConversation').each(function (index,item) {
                                                var img = $(this).find('.img_cont').children('img').attr("src");
                                                var id_container = $(this).attr("id");
                                                        $(this).find('.container_message').each(function () {
                                                            if ($(this).attr("id") == parseInt(data["me"]) && data["data"]["destinataire"]== me) {
                                                                $(this).html("");
                                                                
                                                                container_conversation.push($(this));
                                                            }
                                                        });
                                                });
                                                   
                                                
                                                if (container_conversation.length > 0) {
                                                    /**
                                                     * infectation de message pour chaque panel de conversation
                                                     **/
                                                    for (var i = 0; i < container_conversation.length; i++) {
                                                        if (container_conversation[i].attr("id") == data["me"]) {
                                                            console.log("ok");
                                                            createElementsNode(true, container_conversation[i]);
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                        //});

                                        /**
                                         * notification des panel qui vient de recevoir un message
                                         **/
                                        panel_block = [];
                                        $('.boiteConversation').each(function(){
                                            if($(this).css("display") == "block"){
                                                
                                                var user = {
                                                    "id":$(this).attr("id"),
                                                    "img":$(this).find('.img_cont').find('img').attr("src"),
                                                    "msgNotView":true,
                                                    //"data": data
                                                };
                                                panel_block.push(user);

                                                
                                                if(nbPanelShow > 0){
                                                    animClr(data["me"]);   
                                                } 
                                                
                                            }
                                        });
                                        
                                        function updateMsgNotView(){
                                         
                                            for(var i=0; i<panel_block.length; i++){
                                                var userFound = false;
                                                    for(var j=0; j<list_message_not_view.length; j++){
                                                        if(panel_block[i].id == list_message_not_view[j]["me"]){
                                                            var elemDel = list_message_not_view.splice(j,1);
                                                            tab_temp_old_data_delete.push(elemDel[0]);
                                                        }
                                                }
                                            }  
                                        }
                                        
                                        if(!active_msg_not_view){
                                             
                                            if(panel_block.length == 2 && list_message_not_view.length > 0){
                                                
                                                updateMsgNotView();
                                                
                                                if(list_message_not_view.length > 0){
                                                    showUserInPanelMsgNotView();
                                                }
                        
                                                active_msg_not_view = true;
                                            }
                                        }else{

                                                if(list_message_not_view.length > 0){
                                                  
                                                    var list_temp = list_message_not_view;
                                                    list_message_not_view = [];
                                                    list_message_not_view = list_temp.concat(tab_temp_old_data_delete); 
                                                    tab_temp_old_data_delete = [];
                                                }
                                                updateMsgNotView();
                                                
                                                
                                                //list_message_not_view = new Set(list_message_not_view);
                                                //list_message_not_view = Array.from(list_message_not_view);

                                                if(list_message_not_view.length > 0){
                                                    showUserInPanelMsgNotView();
                                                }
                                            }
                                    }
                                }
                            }
                            
                        case "chargementMessage":
                            
                            /**
                            raha mitovy ny tompon le session sy ilay panel msokatra de ze atw ajour ilay msg
                            */
                            $('body').find('.boiteConversation').each(function(){
                                if($(this).attr("id") == data["data"]["destinataire"] && me == data["me"]){
                                    var container = $(this).find('.container_message');
                                    createElementsNode(true, container);
                                           
                                }
                            });
                                  
                }
            }
        };

        /**
         * affichage de liste de panel de conversation
         * @param list_user
         **/
        function showPanelConversation(list_user_to_create_dialog, User, isNbPanelDecrement) {
            
            /**
             * affichage de boite de conversation
             */
            if (list_user_to_create_dialog.length == 1) {
                /**
                 * premier boite de conversation
                 **/
                $('.boiteConversation:last').attr({
                    //"id": list_user_to_create_dialog[0].to
                    "id":User.to
                });
                conversationOneShow = true;
                $('.boiteConversation:last').find('.user_img').attr({
                    "src": list_user_to_create_dialog[0].img
                });
                $('.boiteConversation:last').find('.user_info').children('span').text("Conversation avec " + list_user_to_create_dialog[0].login);
                $('.boiteConversation:last').find('.user_info').children('span').attr({
                    "id": list_user_to_create_dialog[0].to
                });
                $('.boiteConversation:last').find('.img_cont').children('span').removeClass().addClass(list_user_to_create_dialog[0].status);

                $('textarea:last').attr({
                    "id": User.to
                });
                $('.msg_content:last').attr({
                    "id": User.to
                });
                //$('.msg_content:last').html("");

                $('.boiteConversation:last').find('.content_msg').attr({
                    "id": User.to
                });
                $('.boiteConversation:last').css({
                    "display":"block"
                });

                $('.lastMsg:last').attr({
                    //"id": User.to
                });

                /**
                 * ato ny chargen ny conversation reetra tany alu
                 */
                $('.boiteConversation:last').children('.card-body').show();
                //napina t@ sabotsy
                if(bgCardBody){
                    $('.boiteConversation:last').children('.card-header').css({
                        "background":bgCardBody
                    });
                }
                $('.type_msg:last').click(function(){
                    if(bgCardBody){
                        $('.boiteConversation:last').children('.card-header').css({
                        "background":bgCardBody
                        });
                        bgCardBody = "";
                    }
                });
                
                $('.boiteConversation:last').find('.card-header').css({
                            'background':'rgba(0, 0, 0, 0.03)'
                });
                            
                $('.boiteConversation:last').find('.container_message').html("");
            
                $('.boiteConversation:last').find('.send_btn').attr({
                    "id":User.to
                })
                

            } else {

                if (conversationOneShow) {

                    $('.boiteConversation:first').find('.send_btn').attr({
                        "id":User.to
                    })
                    $('.boiteConversation:first').attr({
                        "id": User.to
                    });
                    /**
                     * deuxième boite de conversation
                     */
                    if (list_user_to_create_dialog[0] != list_user_to_create_dialog[1]) {
                        $('.boiteConversation:first').find('.user_img').attr({
                            "src": list_user_to_create_dialog[1].img
                        });
                        $('.boiteConversation:first').find('.user_info').children('span').text("Conversation avec " + list_user_to_create_dialog[1].login);
                        $('.boiteConversation:first').find('.user_info').children('span').attr({
                            "id": list_user_to_create_dialog[1].to
                        });
                        $('.boiteConversation:first').find('.img_cont').children('span').removeClass().addClass(list_user_to_create_dialog[1].status);
                        $('.boiteConversation:first').css({
                            "display": "block"
                        });
                        $('.msg_content:first').attr({
                            "id": User.to
                        });
                        //$('.msg_content:first').html("");
                        $('.type_msg:first').attr({
                            "id": User.to
                        });
                        
                        $('.lastMsg:first').attr({
                            //"id":User.to
                        });
                        
                        /**
                         * ato ny chargen ny conversation reetra tany alu le deuxième panel
                         */
                        $('.boiteConversation:first').children('.card-body').show();

                        
                        $('.boiteConversation:first').find('.card-header').css({
                            'background':'rgba(0, 0, 0, 0.03)'
                        });
                            
                        $('.boiteConversation:first').find('.container_message').html("");   
                    }
                }
            }
            nbPanelShow ++;
            if(nbPanelShow >1){
                nbPanelShow = 1;
            }
            if(isNbPanelDecrement){
                if(nbPanelShow >1){
                    nbPanelShow = 1;
                }
            }
            
            if(user_clicked){
                
                var datas = {
                    "type": "other",
                    "me": User.to,
                    "data": {
                        
                        "destinataire": User.to,
                        
                    },
                    "messageData":{

                    }
                };
                
                if(list_message_not_view.length == 0){
                    list_message_not_view.push(datas);    
                }else{   
                    
                    for(var i=0; i<list_message_not_view.length; i++){
                        var userFound = false;
                        for(var j=0; j<list_message_not_view.length; j++){
                            if(list_message_not_view[j]["me"] == datas["me"] && list_message_not_view[j]["data"]["destinataire"] == datas["data"]["destinataire"]){
                                userFound = true;
                            }    
                        }
                        
                        if(!userFound){
                            list_message_not_view.push(datas); 
                            
                            //userFound = false;
                        }
                    }       
                }
                /**
                if(list_message_not_view.length > 2){
                    panel_block = [];
                    $('.boiteConversation').each(function(){
                        panel_block.push($(this));
                    });
                    for(var i=0; i<panel_block.length; i++){
                        for(var j=0; j<list_user_show_preview.length; j++){
                            if(panel_block[i].attr("id") == list_user_show_preview[j]){
                                list_user_show_preview.splice(j,1);
                            }
                        }
                    }
                    for(var i=0; i<list_user_show_preview.length; i++){
                        console.log($('.boiteConversation#'+list_user_show_preview[i]));
                    }
                    
                }
                *
                */

            }
            else{
                user_clicked = true;
                user_closed_after_msg_receving = false;
                /**
                * si il recoit une message, on
                reinitialise le compteur
                */
                if(list_id_and_compteur_msg_last.length > 0){
                    for(var i=0; i<list_id_and_compteur_msg_last.length; i++){
                        if(list_id_and_compteur_msg_last[i].id == data["data"]["destinataire"]){
                            list_id_and_compteur_msg_last[i].cpt = 1;
                        }
                    }
                }
                //$('.lastMsg').trigger('click');
            }
            
            data["type"] = "chargementMessage";
            data["data"]["destinataire"] = User.to;
            
            ws.send(JSON.stringify(data));   
        }

        var $classUser = $('.lienbox');
        var block = [];
        var isEntryHere = false;
        var conversationOneShow = false;
        
        /**
        * voir la liste des message 1 jour avant la dernier message postée
        **/
        //$('.lastMsg').each(function(){
            //var lastMsg = $(this);
            $('.lastMsg').click(function(){
                var lastMsg = $(this);
                var compteur = {
                        id: $(this).attr("id"),
                        cpt: 2
                };
                if(list_id_and_compteur_msg_last.length == 0){
                    list_id_and_compteur_msg_last.push(compteur);
                }else{
                    if(list_id_and_compteur_msg_last.length == 1){
                        if(list_id_and_compteur_msg_last[0].id == compteur.id){
                            list_id_and_compteur_msg_last[0].cpt = list_id_and_compteur_msg_last[0].cpt + 1;
                        }else{
                            list_id_and_compteur_msg_last.push(compteur);
                        }
                    }else{
                        var userFound = false;
                        var pos = 0;
                        for(var i=0; i<list_id_and_compteur_msg_last.length; i++){    
                            if(list_id_and_compteur_msg_last[i].id == compteur.id){
                                userFound = true;
                                pos = i;
                            }
                        }
                        if(userFound){
                                list_id_and_compteur_msg_last[pos].cpt = list_id_and_compteur_msg_last[pos].cpt + 1;
                        }else{
                            list_id_and_compteur_msg_last.push(compteur);
                        }
                    }
                }
                $classUser.each(function(){
                    if($(this).attr("id") == lastMsg.attr("id")){
                        $(this).trigger('click');
                    }
                });
            });
        //});
        
        //click sur une destinataire de messagerie
        $('body').delegate('.lienbox', 'click', function (e) {
            e.preventDefault();
            console.log("ok");
            nb_panel_show = 2;
            /**
             * si la list_user est vide, on initialise isEntryHere
             */
            if (list_user_to_create_dialog.length == 0) {
                isEntryHere = false;
            }
            
            var User = {
                to: $(this).attr("id"),
                img: $(this).find('img').attr("src"),
                login: $(this).find('.user_info').find('span').text().split(" - ")[1],
                status: $(this).find('.img_cont > span').attr("class"),
            };

            info_destinataire = User;
            //2 no maximum ilay discussion instantanée
            if (list_user_to_create_dialog.length < 2) {
                //ato ny faharoa
                if (isEntryHere) {
                    //ka raha tsy mtovy ilay ul de apina
                    if (list_user_to_create_dialog[0].to != User.to) {
                        list_user_to_create_dialog.push(User);
                    }
                }
                //miditra ato alu volo mameno ilay ol volo
                if (!isEntryHere) {
                    //list_user_to_create_dialog.push(user_id);
                    list_user_to_create_dialog.push(User);
                    isEntryHere = true;
                }
            }

            //raha ef 2 ilay olona
            if (list_user_to_create_dialog.length == 2) {
                //ka ilay olona vao2 tsy mtovy @ ilay olona teo aloha, ovaina anin ul in ilay faha2
                if (list_user_to_create_dialog[1].to != User.to) {
                    list_user_to_create_dialog[1] = User;
                }
                //raha ef ao ilay olona de videna dul ilay liste de in ul in ian no atao ao anatin ilay liste
                if (list_user_to_create_dialog[0].to == User.to) {
                    list_user_to_create_dialog = [];
                    list_user_to_create_dialog.push(User);
                    //list_user_to_create_dialog[0] = User;
                }
            }
            list_panel_default = list_user_to_create_dialog;

            /**
            si la panel de conversation est tous caché
            et s'il y est dans la list des message not view
            on la retire dans ce dernier
            **/
            panel_block = [];
            $('.boiteConversation').each(function(){
                if($(this).css("display") == "block"){
                    var user = {
                        id: $(this).attr("id")
                    }
                    panel_block.push(user);
                }
            })
            
            if($('#message_not_view').find('.contact').length > 0){
                if(panel_block.length == 0){
                    //for(var j=0; j<block_panel_after_show.length;j++){
                        var found = false;
                        if(User.to == $('#message_not_view').find('.contact#'+User.to).attr("id")){
                            found = true;
                            $('#message_not_view').find('.contact#'+User.to).remove();   
                        }
                    //}
                }

            }

            /**
             * affichage de panel de conversation
             */
            showPanelConversation(list_user_to_create_dialog, User);

            
            //manala ilay couleur sisa no atw ref mis message 
            var block_panel_after_show = [];
            panel_block = [];
            $('.boiteConversation').each(function(){
                if($(this).attr("id") != "element2"){
                    list_user_show_preview.push($(this).attr("id"));    
                    block.push($(this).attr("id"));
                }
                if($(this).css("display") == "block"){
                    block_panel_after_show.push($(this).attr("id"));
                    var user = {
                        id: $(this).attr("id")
                    }
                    panel_block.push(user);
                    
                    
                    //console.log(bgCardBody)
                }
            });

            
            /**
            si on clique un destinataire
            et qu'il est dans la panel des msg not view
            on l'enleve dans ce dernier
            **/
            if($('#message_not_view').find('.contact').length > 0){
                if(block_panel_after_show.length == 1){
                    for(var j=0; j<block_panel_after_show.length;j++){
                        var found = false;
                        if(block_panel_after_show[j] == $('#message_not_view').find('.contact#'+block_panel_after_show[j]).attr("id")){
                            found = true;
                            $('#message_not_view').find('.contact#'+block_panel_after_show[j].id).remove();   
                        }
                    }
                }

            }
            //manw ajout le click eo @ panel not view za zo
            
            if(panel_block.length == 2 && list_message_not_view.length>0){
                if(msgReceving){
                    list_message_not_view = tab_temp_old_data_delete.concat(list_message_not_view);
                    msgReceving = false;
                    return;
                }
                
                for(var i=0; i<list_message_not_view.length;i++){
                    for(var j=0; j<tab_temp_old_data_delete.length;j++){
                        if(list_message_not_view[i]["me"] == tab_temp_old_data_delete[j]["me"]){
                            tab_temp_old_data_delete.splice(j,1);
                        }
                    }
                }
                
                list_message_not_view = list_message_not_view.concat(tab_temp_old_data_delete);
                
                for(var i=0; i<panel_block.length; i++){
                    for(var j=0; j<list_message_not_view.length; j++){
                        if(panel_block[i].id == list_message_not_view[j]["me"]){
                            
                            tab_temp_old_data_delete.push(list_message_not_view[j]);
                            list_message_not_view.splice(j,1); 
                        }
                    }
                }
                //console.log("apres",list_message_not_view);
                showUserInPanelMsgNotView();
                for(var i=0; i<list_message_not_view.length;i++){
                    for(var j=0; j<tab_temp_old_data_delete.length;j++){
                        if(list_message_not_view[i]["me"] == tab_temp_old_data_delete[j]["me"]){
                            tab_temp_old_data_delete.splice(j,1);
                        }
                    }
                }
                list_message_not_view = list_message_not_view.concat(tab_temp_old_data_delete);
                
            }
                 
        });

        /**
         * fermeture messagerie
         */
         var panel_temp = [];
        $('.close_conversation').click(function () {
			
            var $parent = $(this).parents('.boiteConversation'); 
            var id_user = $(this).parents('.boiteConversation').attr("id");
            //eto za zo ny ulan de las bdb le list_message_not_view rehef manw permutation
            panel_block = [];

            $('.boiteConversation').each(function(){
                if($(this).css("display") == "block"){
                    var user = {
                        id: $(this).attr("id")
                    }
                    panel_block.push(user);
                }
            });
            panel_temp = panel_block;
            
            for(var i=0; i<list_message_not_view.length;i++){
                if(list_message_not_view[i]["me"] == id_user){
                    list_message_not_view.splice(i,1);
                }
            }
            
            for(var i=0; i<list_user_to_create_dialog.length;i++){
                if(list_user_to_create_dialog[i].to == id_user){
                    list_user_to_create_dialog.splice(i,1);
                }
            }
            
            for(var i=0; i<tab_temp_old_data_delete.length;i++){
                if(tab_temp_old_data_delete[i]["me"] == id_user){
                    tab_temp_old_data_delete.splice(i,1);
                } 
            }
            
            $('.boiteConversation').css({
                "display": "none"
            });

            var panel_show = [];

            for(var i=0; i<panel_block.length;i++){
                for(var j=0; j<tab_temp_old_data_delete.length;j++){
                    if(panel_block[i].id == tab_temp_old_data_delete[j]["me"]){
                        tab_temp_old_data_delete.splice(j,1);
                    }    
                }
                if(panel_block[i].id == id_user){
                    panel_block.splice(i,1);
                }
                
            }
            //console.log(panel_block);

            if(panel_block.length > 0){
                for(var i=0; i<panel_block.length;i++){
                        var user = {
                            to: panel_block[i].id,
                            img: $('.lienbox#'+panel_block[i].id).find('img').attr("src"),
                            login:$('.lienbox#'+panel_block[i].id).find('.user_info').find('span').text().split(" - ")[1],
                            status:$('.lienbox#'+panel_block[i].id).find('.img_cont > span').attr("class")
                        }
                    panel_show.push(user);
                }
                user_clicked = false;
                showPanelConversation(panel_show, panel_show[0]); 

            }
           

        });
        
         $('#minimize_messagerie').click(function () {
            var $card_body = $(this).parents('.chatbox').children('.card-body');
            $card_body.slideToggle();
         });
        


        /**
        * minimize messagerie
         * 
         */
        var $minimize_messagerie = $('.minimize');
        var user_closed_after_msg_receving = true;
        $minimize_messagerie.click(function () {
            var users_deletes = [];
            var $parent = $(this).parents('.boiteConversation');
            
            var User = {
                to: $parent.find('.user_info').children('span').attr("id"),
                img: $parent.find('.user_img').attr("src")
            };

            panel_block = [];

            var array_temp = [];
            for (var i = 0; i < list_user_to_create_dialog.length; i++) {
                if (list_user_to_create_dialog[i].to != User.to) {
                    array_temp.push(list_user_to_create_dialog[i]);
                }
            }

            list_user_to_create_dialog = array_temp;

            $('.boiteConversation').css({
                "display": "none"
            });

            if (list_user_to_create_dialog.length == 0) {
                if(msgReceving){
                    
                    msgReceving = false;
                    panel_block = [];
                }
                if(list_message_not_view.length == 1){
                    
                    for(var i=0; i<list_message_not_view.length; i++){
                        if(list_message_not_view[i]["me"] == $parent.find('.user_info').children('span').attr("id")){
                            //tab_temp_old_data_delete.push(list_message_not_view[i]);
                            list_message_not_view.splice(i,1);
                        }
                    }
                }
                
                //panel_block = [];  
                $('.boiteConversation').each(function(){
                    if($(this).css("display") == "block"){
                        var user = {
                            id:$(this).attr("id")
                        }
                        panel_block.push(user);
                    }
                });
                
                var datas = {
                    "type": "other",
                    "me": $parent.find('.user_info').children('span').attr("id"),
                    "data": {
                        
                        "destinataire": $parent.find('.user_info').children('span').attr("id"),
                    },
                    "messageData":{

                    }
                };
                   
                list_message_not_view.push(datas);  
                //tab_temp_old_data_delete.push(datas);

                
                showUserInPanelMsgNotView($('#message_not_view'), list_message_not_view);

                $('.type_msg').click(function(){
                    $('.boiteConversation:last').children('.card-header').css({
                        "background":'rgba(0, 0, 0, 0.03)'
                    });
                });
                
                return;
            }
            /**
             * affichage de conversation
             */

            showPanelConversation(list_user_to_create_dialog, list_user_to_create_dialog[0], true);
            /**
            if(!msgReceving){
                    console.log("makato");
                    $('.boiteConversation').find('.card-header').css({
                        "background":'crimson'
                })
            }**/
            //eto mbl tsy met
            
              
            $('.boiteConversation').each(function(){
                if($(this).css("display") == "block"){
                    var user = {
                        id:$(this).attr("id")
                    }
                    panel_block.push(user);
                }
            });
            
            if(!user_closed_after_msg_receving){

                var datas = {
                    "type": "other",
                    "me":User.to,
                    "data": {
                        
                        "destinataire": User.to
                    },
                    "messageData":{

                    }
                };
                if(evit_not_doublons){
                    
                    var user_do_appended = false;
                    for(var i=0; i<list_message_not_view.length; i++){
                        if(list_message_not_view[i]["me"] == datas["me"]){
                            //tab_temp_old_data_delete.push(list_message_not_view[i]);
                            list_message_not_view.splice(i,1);
                            list_message_not_view.push(datas);
                            user_do_appended = true;
                        }
                    }
                    if(!user_do_appended){
                        list_message_not_view.push(datas);
                    }
                }else{
                    list_message_not_view.push(datas);
                }
            }
            
            for(var i=0; i<list_message_not_view.length; i++){
                for(var j=0; j<panel_block.length; j++){
                    if(list_message_not_view[i]["me"] == panel_block[j].id){
                        tab_temp_old_data_delete.push(list_message_not_view[i]);
                        user = list_message_not_view[i];
                        list_message_not_view.splice(i,1);
                        //tab_temp.push(list_message_not_view[i]);
                    }    
                }
            }
            //list_message_not_view = tab_temp_old_data_delete.concat()
            //console.log("apres",list_message_not_view);
            //console.log("ato za zo ny ulan las doublons dul le sary de vo clicken de mial dul");
            showUserInPanelMsgNotView($('#message_not_view'), list_message_not_view);
            
        });
    });

    /**
     *recherche d'utilisateurs dans la messagerie
     */
    $(function () {
        $('input.search').keyup(function (e) {
            var value = $(this).val();

            var reg = / /;
            var expression = reg.compile(value,"i");

            $('.contacts').each(function(){
                if(value != ""){
                    $(this).css({"display":"block"});//d'abord on reaffiche cette element
                    if(!expression.test($(this).attr("id")) && !expression.test($(this).attr("data-id"))){
                        $(this).css({
                           "display":'none'
                        });
                    }
                }else{
                    $('ui').css({
                        "display":'block'
                    })
                }
            });
        });
    });

</script>


{% block javascripts %}{% endblock %}
</body>
</html>
